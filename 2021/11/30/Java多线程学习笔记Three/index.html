<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Kirang Haerang:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="屁话​        这篇文章来记录在学习 Java多线程 的相关基础时的一部分想法。这次主要包含 线程优先级， 守护线程 ， 线程同步 和 锁 4个部分的内容。 线程优先级​        线程优先级指 CPU 在运行过程中对某个线程的调用优先度。当然，线程是否被调用取决于 CPU 的心情，完全取决于 CPU。​        因此，即使设置了 CPU 的优先级也可能出现优先级低的反而被优先级高">
<meta property="og:type" content="article">
<meta property="og:title" content="Java多线程的学习笔记--线程优先级、守护线程、线程同步、锁">
<meta property="og:url" content="http://example.com/2021/11/30/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0Three/index.html">
<meta property="og:site_name" content="神秘的世界">
<meta property="og:description" content="屁话​        这篇文章来记录在学习 Java多线程 的相关基础时的一部分想法。这次主要包含 线程优先级， 守护线程 ， 线程同步 和 锁 4个部分的内容。 线程优先级​        线程优先级指 CPU 在运行过程中对某个线程的调用优先度。当然，线程是否被调用取决于 CPU 的心情，完全取决于 CPU。​        因此，即使设置了 CPU 的优先级也可能出现优先级低的反而被优先级高">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-30T08:31:27.509Z">
<meta property="article:modified_time" content="2022-07-13T12:03:37.178Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2021/11/30/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0Three/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Java多线程的学习笔记--线程优先级、守护线程、线程同步、锁 | 神秘的世界</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">神秘的世界</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/30/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0Three/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="神秘的世界">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java多线程的学习笔记--线程优先级、守护线程、线程同步、锁
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-11-30 16:31:27" itemprop="dateCreated datePublished" datetime="2021-11-30T16:31:27+08:00">2021-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-13 20:03:37" itemprop="dateModified" datetime="2022-07-13T20:03:37+08:00">2022-07-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="屁话"><a href="#屁话" class="headerlink" title="屁话"></a>屁话</h2><p>​        这篇文章来记录在学习 Java多线程 的相关基础时的一部分想法。这次主要包含 <strong>线程优先级</strong>， <strong>守护线程</strong> ， <strong>线程同步</strong> 和 <strong>锁</strong> 4个部分的内容。</p>
<h2 id="线程优先级"><a href="#线程优先级" class="headerlink" title="线程优先级"></a>线程优先级</h2><p>​        线程优先级指 CPU 在运行过程中对某个线程的调用优先度。当然，线程是否被调用取决于 CPU 的心情，完全取决于 CPU。<br>​        因此，即使设置了 CPU 的优先级也可能出现优先级低的反而被优先级高的先调用，也就是出现资源倒置。<br>​        对于某一个线程而言，若不调用相关方法显示的进行设置，否则线程的优先级默认为中间值，也就是 5。前文中提到了可以用相关方法对线程优先级进行显示设置，在 Thread 类中拥有一个方法：setPriority( int Num ) 这个方法可以显示设置线程的优先级。与之对应的是另一个方法 getPriority(  ) 这个方法可以主动的返回线程的优先级。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().setPriority(<span class="keyword">int</span> Num);</span><br><span class="line">Thread.currentThread().getPriority(  );</span><br></pre></td></tr></table></figure>

<p>​        在线程中存在三个特别的常数：MAX_PRIORITY、MIN_PRIORITY、NORM_PRIORITY 这个三个常数分别代表 Java 线程中的三种优先级。即 最高优先级MAX_PRIORITY = 10，最低优先级MIN_PRIORITY = 1，默认优先级NORM_PRIORITY  = 5 。</p>
<p>​        一般情况下，如果在调用 setPriority 函数时，传入了 <strong>大于10</strong> 或者 <strong>小于1</strong> 的参数，将会导致异常发生。</p>
<p>​        另外，如果要人为的改变线程的优先级，需要对线程先设置后启动。在线程执行启动后，优先级更高的线程更有可能得到 CPU 的资源，因此虽然线程的调用完全取决于 CPU 但线程优先级还是有一定作用的。</p>
<p>​        </p>
<h2 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h2><p>​        在 Java 中运行的线程可以分为两种 ：User Thread用户线程 和 Daemon Thread守护线程。</p>
<p>​        举一个比较经典的例子：每次程序运行时的 main 方法就是一个标准的用户线程，而每次在程序运行时在 Java 虚拟机中默默工作的 gc 垃圾回收线程 就是一个经典的守护线程。</p>
<p>​        </p>
<p>​        守护线程和用户线程区别在于，用户线程在执行完线程中的内容后就会死亡，而守护线程并不会。守护线程只有当当前 JVM 中所有的正在运行和等待运行的用户线程全部结束后，守护线程才会自动结束。</p>
<p>​        JDK 自动的提供了一些守护线程，就像 Java 程序需要 main 方法才可以运行， JDK 提供的许多守护线程如 gc 垃圾回收线程都是自动运行，无需调用且在进程完全结束后停止的。</p>
<p>​        相对于 JDK 提供的线程，我们是可以自己手动设置守护线程的。设置守护线程需要一个包含在 Thread 类中的相关方法：setDaemon( true ) 这个方法，在这个方法中，传入的参数应该为 true 代表这个这个线程从此被设置为守护线程。</p>
<p>​        另外，如果一个守护线程是我们自己设定的，那么依然需要执行该线程的 start 方法，来启动这个线程。</p>
<p>​        下面给出一个自定义守护线程的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDaemon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BigBrother bigBrother = <span class="keyword">new</span> BigBrother();</span><br><span class="line">        LittleKid littleKid = <span class="keyword">new</span> LittleKid();</span><br><span class="line"></span><br><span class="line">        Thread threadDaemon = <span class="keyword">new</span> Thread( bigBrother );</span><br><span class="line">        threadDaemon.setDaemon( <span class="keyword">true</span> );</span><br><span class="line">        threadDaemon.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread( littleKid ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigBrother</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="keyword">true</span> )&#123;</span><br><span class="line">            System.out.println( <span class="string">&quot; Big Brother Look You &quot;</span> );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">500</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LittleKid</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++ ) &#123;</span><br><span class="line">            System.out.println( <span class="string">&quot; I Love Big Brother Everyday Forever &quot;</span> );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在上方的代码执行后，可以从结果中看见，守护线程和用户线程是一起运行的，直到用户现场执行完毕，守护线程才进入线程死亡的流程。由于线程死亡是需要一定的时间的，因此才不是当用户线程结束后当场暴毙。当然，理论上用户线程死亡的同时守护线程就会同时死亡。</p>
<h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2><h4 id="三大不安全案例"><a href="#三大不安全案例" class="headerlink" title="三大不安全案例"></a>三大不安全案例</h4><p>​        未进行同步的线程是相当不安全的，比如多个线程同时操作同一个资源。此时就有极大概率发生线程不安全，下面可以提供三个比较经典的例子：</p>
<ul>
<li>多人同时抢票</li>
<li>银行同时取钱</li>
<li>list 线程不安全</li>
</ul>
<p>​        我们对这三个例子一个一个进行实现，分析她们不安全的原因。</p>
<h6 id="多人同时抢票"><a href="#多人同时抢票" class="headerlink" title="多人同时抢票"></a>多人同时抢票</h6><p>​        首先按照对这个情景进行实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不安全的买票 线程不安全，存在负数</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeBuyStack</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BuyStack buyStack = <span class="keyword">new</span> BuyStack();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Jojo&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Dio&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Putsch&quot;</span> ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyStack</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> Stack = <span class="number">10</span>; <span class="comment">// 总票数</span></span><br><span class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">true</span>; <span class="comment">// 用于停止线程的标志位</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 买票用线程</span></span><br><span class="line">        <span class="keyword">while</span> ( flag ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( Stack &lt;= <span class="number">0</span> ) &#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( Thread.currentThread().getName() + <span class="string">&quot; get for the &quot;</span> + Stack + <span class="string">&quot; package &quot;</span> );</span><br><span class="line">        Stack = Stack - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        将上面的程序执行后，可以发现两个十分严重的问题：</p>
<ul>
<li><p>三个人同时拿到了同一张票，出现了资源的争夺</p>
</li>
<li><p>拿票时，有人在拿票时拿到了 -1 ，-2张票，这显然是不可能的</p>
<p>​    分析：</p>
<ul>
<li>三条线程同时执行，对一项公共资源进行操作。在执行时，对于三条线程而言，在对公共资源进行操作时，票的数量都是一样的。假设还有 10 张票，那么三条线程会同时对第 10 张票进行操作。那么这三条线程拿到的就是同一张票，而这是不被允许的。</li>
<li>根据上面的分析可以得出，当只有最后 1 张票后，三条线程依旧会同时对这唯一的一张票进行操作，但此时剩余的资源已经不再可以满足三条线程的需要，因此会出现负数。</li>
</ul>
</li>
</ul>
<h6 id="银行同时取钱"><a href="#银行同时取钱" class="headerlink" title="银行同时取钱"></a>银行同时取钱</h6><p>​        首先对这个情景进行实现：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeBank</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Account account = <span class="keyword">new</span> Account( <span class="number">1000</span>, <span class="string">&quot;Fuck you Money&quot;</span> );</span><br><span class="line"></span><br><span class="line">        Bank bankOnw = <span class="keyword">new</span> Bank( account, <span class="number">600</span>, <span class="string">&quot;Dio&quot;</span> );</span><br><span class="line">        Bank bankTwo = <span class="keyword">new</span> Bank( account, <span class="number">600</span>, <span class="string">&quot;Jojo&quot;</span> );</span><br><span class="line"></span><br><span class="line">        bankOnw.start();</span><br><span class="line">        Thread.yield();</span><br><span class="line">        bankTwo.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 账户</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> money;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> money, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 银行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Account account;</span><br><span class="line">    <span class="keyword">int</span> drawMoney;</span><br><span class="line">    <span class="keyword">int</span> nowMoney;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bank</span><span class="params">(  Account account, <span class="keyword">int</span> drawMoney, String Name )</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>( Name );</span><br><span class="line">        <span class="keyword">this</span>.account = account;</span><br><span class="line">        <span class="keyword">this</span>.drawMoney = drawMoney;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public void run() &#123;</span></span><br><span class="line"><span class="comment">//        // 此处模拟延时</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            Thread.sleep( 1000 );</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        if ( account.getMoney() - drawMoney &lt; 0 )&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println( Thread.currentThread().getName() + &quot; Unable to withdraw &quot; );</span></span><br><span class="line"><span class="comment">//            return;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        account.setMoney( account.getMoney() - drawMoney );</span></span><br><span class="line"><span class="comment">//        nowMoney = drawMoney + nowMoney;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        System.out.println( account.getId() + &quot; have -&gt; &quot; + account.getMoney() );</span></span><br><span class="line"><span class="comment">//        System.out.println( Thread.currentThread().getName() + &quot; have -&gt;&gt;&gt;&gt; &quot; + nowMoney );</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">500</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( account.getMoney() - drawMoney &lt; <span class="number">0</span> )&#123;</span><br><span class="line">            System.out.println( Thread.currentThread().getName() + <span class="string">&quot; Unable to withdraw &quot;</span> );</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        account.setMoney( account.getMoney() - drawMoney );</span><br><span class="line">        nowMoney = drawMoney + nowMoney;</span><br><span class="line"></span><br><span class="line">        System.out.println( account.getId() + <span class="string">&quot; have -&gt; &quot;</span> + account.getMoney() );</span><br><span class="line">        System.out.println( Thread.currentThread().getName() + <span class="string">&quot; have -&gt;&gt;&gt;&gt; &quot;</span> + nowMoney );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        对上面的代码进行运行后，会发现程序出现了几个严重的问题：</p>
<ul>
<li><p>两条线程同时从银行中提取现金，提取的总金额大于账户中的总金额</p>
</li>
<li><p>两条线程在上一例的情况下依旧可以从银行中执行提取金额的指令，导致银行中的账户出现了负数    </p>
<p>分析： </p>
<ul>
<li>基本原因和上一个场景相同，由于两条线程同时对一个共有的对象进行操作，导致资源同时被访问，从而出现了负数和取出的金额量大于总数的情况。</li>
</ul>
</li>
</ul>
<h6 id="list-线程不安全"><a href="#list-线程不安全" class="headerlink" title="list 线程不安全"></a>list 线程不安全</h6><p>​        首先对这个情景进行实现：    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程不安全的集合</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt; String &gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要注意的是 synchronized 应该在包含在 run 表达式中，否则起不到锁定的作用</span></span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ ) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">                list.add( Thread.currentThread().getName() );</span><br><span class="line">            &#125; ).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此处需要延时操作，否则主线程会提前结束 从而导致 线程结束，引发错误</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( list.size() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        对上面的代码执行后，会发现一个十分重要的问题：</p>
<ul>
<li><p>按照程序的目标，我们希望在程序结束后所定义的 ArrayList 拥有 10000 个元素。但实际上运行结束后，无论如何 ArrayList 中的元素并不足 10000 项。</p>
<p>分析：</p>
<ul>
<li>在有足够的时间给线程运行的情况下，依旧会出现线程不安全的情况。这是由于 ArrayList 本身就是一个对于同步线程不安全的泛型，每次循环中都会开启一次线程，在这个过程中就会出现重复线程，从而相互覆盖导致元素数量不足。</li>
</ul>
</li>
</ul>
<p>​        此外要说明的是，即使通过 同步块、CopyOnWriteArrayList 或者 Lock 对资源进行上锁完成同步，如果不再 main 方法中设置延时，那么最后的结果依旧不安全。这是因为 main 主线程的执行速度过快从而导致已经安全的同步线程未完全执行。</p>
<h4 id="同步块-以及-同步方法"><a href="#同步块-以及-同步方法" class="headerlink" title="同步块 以及 同步方法"></a>同步块 以及 同步方法</h4><p>​        可以看出上方不同步的方法会导致线程和资源的不安全，因此我们需要使用某种方法使得这些不安全的方法达到同步。Java 的锁机制由此而出，锁的原理在下一部分再来讨论。</p>
<p>​        总而言之，使用 synchronized 关键字方法 或者 synchronized 代码块 来完成对公共资源的锁定，从而保证线程的安全。下面将三大不安全案例使用 synchronized 案例进行改写，从而使得她们达到同步安全：</p>
<h6 id="多人同时抢票–同步"><a href="#多人同时抢票–同步" class="headerlink" title="多人同时抢票–同步"></a>多人同时抢票–同步</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不安全的买票 线程不安全，存在负数</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeBuyStack</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BuyStack buyStack = <span class="keyword">new</span> BuyStack();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Jojo&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Dio&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyStack, <span class="string">&quot;Putsch&quot;</span> ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyStack</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> Stack = <span class="number">10</span>; <span class="comment">// 总票数</span></span><br><span class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">true</span>; <span class="comment">// 用于停止线程的标志位</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 买票用线程</span></span><br><span class="line">        <span class="keyword">while</span> ( flag ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( Stack &lt;= <span class="number">0</span> ) &#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( Thread.currentThread().getName() + <span class="string">&quot; get for the &quot;</span> + Stack + <span class="string">&quot; package &quot;</span> );</span><br><span class="line">        Stack = Stack - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        改写操作：</p>
<p>​        分析代码可得，每个线程对于公共资源的操作都是借助于 BuyStack 类中的 buy 方法进行操作，由此为了使得方法变得同步，我们将 buy 方法变为 同步方法，也就是在返回值类型前加上 synchronized。</p>
<h6 id="银行同时取钱–同步"><a href="#银行同时取钱–同步" class="headerlink" title="银行同时取钱–同步"></a>银行同时取钱–同步</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeBank</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Account account = <span class="keyword">new</span> Account( <span class="number">1000</span>, <span class="string">&quot;Fuck you Money&quot;</span> );</span><br><span class="line"></span><br><span class="line">        Bank bankOnw = <span class="keyword">new</span> Bank( account, <span class="number">600</span>, <span class="string">&quot;Dio&quot;</span> );</span><br><span class="line">        Bank bankTwo = <span class="keyword">new</span> Bank( account, <span class="number">600</span>, <span class="string">&quot;Jojo&quot;</span> );</span><br><span class="line"></span><br><span class="line">        bankOnw.start();</span><br><span class="line">        Thread.yield();</span><br><span class="line">        bankTwo.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 账户</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> money;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> money, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 银行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Account account;</span><br><span class="line">    <span class="keyword">int</span> drawMoney;</span><br><span class="line">    <span class="keyword">int</span> nowMoney;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bank</span><span class="params">(  Account account, <span class="keyword">int</span> drawMoney, String Name )</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>( Name );</span><br><span class="line">        <span class="keyword">this</span>.account = account;</span><br><span class="line">        <span class="keyword">this</span>.drawMoney = drawMoney;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public void run() &#123;</span></span><br><span class="line"><span class="comment">//        // 此处模拟延时</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            Thread.sleep( 1000 );</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        if ( account.getMoney() - drawMoney &lt; 0 )&#123;</span></span><br><span class="line"><span class="comment">//            System.out.println( Thread.currentThread().getName() + &quot; Unable to withdraw &quot; );</span></span><br><span class="line"><span class="comment">//            return;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        account.setMoney( account.getMoney() - drawMoney );</span></span><br><span class="line"><span class="comment">//        nowMoney = drawMoney + nowMoney;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        System.out.println( account.getId() + &quot; have -&gt; &quot; + account.getMoney() );</span></span><br><span class="line"><span class="comment">//        System.out.println( Thread.currentThread().getName() + &quot; have -&gt;&gt;&gt;&gt; &quot; + nowMoney );</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">500</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> ( account )&#123;</span><br><span class="line">            <span class="keyword">if</span> ( account.getMoney() - drawMoney &lt; <span class="number">0</span> )&#123;</span><br><span class="line">                System.out.println( Thread.currentThread().getName() + <span class="string">&quot; Unable to withdraw &quot;</span> );</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            account.setMoney( account.getMoney() - drawMoney );</span><br><span class="line">            nowMoney = drawMoney + nowMoney;</span><br><span class="line"></span><br><span class="line">            System.out.println( account.getId() + <span class="string">&quot; have -&gt; &quot;</span> + account.getMoney() );</span><br><span class="line">            System.out.println( Thread.currentThread().getName() + <span class="string">&quot; have -&gt;&gt;&gt;&gt; &quot;</span> + nowMoney );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        改写操作：</p>
<p>​        通过对代码的分析，代码所操作的公共资源是银行账户 Account 类的一个唯一实例，那么即使将 run 方法变为同步方法依旧无法将这项公共资源锁定，也就是说，线程依旧是不安全的。</p>
<p>​        那么这时，我们就需要使用 synchronized 同步块来专门对 Account 类实例相关的代码进行锁定，那么 synchronized 代码块中需要填入的参数就是我们需要操纵的公共资源，在这项代码中就是 Account 类的实例对象。 </p>
<h6 id="list-线程不安全–同步"><a href="#list-线程不安全–同步" class="headerlink" title="list 线程不安全–同步"></a>list 线程不安全–同步</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SYN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程不安全的集合</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt; String &gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要注意的是 synchronized 应该在包含在 run 表达式中，否则起不到锁定的作用</span></span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ ) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> ( list )&#123;</span><br><span class="line">                    list.add( Thread.currentThread().getName() );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; ).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此处需要延时操作，否则主线程会提前结束 从而导致 线程结束，引发错误</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( list.size() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        操作分析：</p>
<p>​        原本的线程不安全出自于每次循环时都会新建一个线程，从而导致某些线程重复，由此造成线程不安全。那么我们即使将 run 方法标记为 synchronized 同步方法也不会达到锁定资源的效果，因为操作的实例对象是 list ，位于方法外。</p>
<p>​        所以我们使用 synchronized 同步方法块，将针对 list 的操作，也就是将每条新建线程的名称作为元素存入到 list 中的这一步标记为同步方法块，从而完成对 list 的资源锁定 和 线程同步。</p>
<h4 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h4><p>​        这并不是一个十分重要的内容，CopyOnWriteArrayList 是一个属于 JUC 中的线程安全，可同步 链表 泛型。JUC 中的内容众多，这只是其中一点内容，这部分和 Callable 创建线程相同，可以只是了解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试安全 list</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJUC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CopyOnWriteArrayList&lt; String &gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt; String &gt;();</span><br><span class="line">        ArrayList&lt; String &gt; listTest = <span class="keyword">new</span> ArrayList&lt; String &gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ ) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">                list.add( Thread.currentThread().getName() );</span><br><span class="line">            &#125; ).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( list.size() );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ ) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> ( listTest )&#123;</span><br><span class="line">                    listTest.add( Thread.currentThread().getName() );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; ).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println( listTest.size() );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><h4 id="锁的基础"><a href="#锁的基础" class="headerlink" title="锁的基础"></a>锁的基础</h4><p>​        先来举一个形象的例子，假如现在有 20 个人一起上厕所，现在厕所只有一个，那么最正常的办法是什么？先排队，然后一个一个的上厕所，每有一个进入厕所就将厕所锁住，等到完事后，将锁打开，下一个人进入厕所解决需求。</p>
<p>​        那么多线程也是同样的道理，有 20 条线程共同抢夺一个公共资源，就如同 20 个人一起上厕所。但线程是不会自己排队的，如果不对线程进行干预，那么就会造成线程不安全。</p>
<p>​        此时，就会引入 锁 的概念。假设每一条线程都有一把锁，那么之前的问题就变得简单了。现在我们对每条线程的锁进行操作，每当一个线程执行方法时，一旦遇到需要对公共资源进行操作，就把这把锁交给公共资源并将其锁上，然后在操作结束后在将锁释放。</p>
<p>​        这样就不会再出现多条线程同时操作一个公共资源的情况了。</p>
<p>​        </p>
<p>​        这就如同上厕所的时候有了锁，每当一条线程开始操作公共资源，就如同上厕所的时候上了锁，这样别人就进不来，也就无法干扰了。</p>
<p>​        </p>
<p>​        那么为了实现 锁 的同步，我们就需要使用 synchronized 关键字来生产 同步方法 或者 同步块，不过在使用 synchronized 关键字时是有一些独特的要求的，否则无法实现对线程的同步和对公共资源的锁定：</p>
<ul>
<li>synchronized 锁定的必须是线程所操作的公共对象，视情况使用 synchronized 代码块 或者 synchronized 方法，如果锁定的对象错误就无法达成线程同步的目的</li>
<li>使用 synchronized 代码块时，需要传入一个对象参数，这个对象参数应该为需要锁定的唯一公共资源，例如在 “银行同时取钱” 的代码中就使用了 synchronized 代码块对 account 进行了锁定，而不是使用 synchronized 同步方法</li>
<li>尽可能的不要在 synchronized  方法 或者 synchronized 代码块中在使用 synchronized 关键字，这样有极大可能会造成<strong>死锁</strong></li>
</ul>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>​        死锁，故名思意，就是完全绞死的锁。举个例子，假设现在有两个人，一个手里有纸要上厕所，另一个在厕所中但没有纸。我们将纸和厕所视作两个公共资源，这时她们都希望使用对方的资源( 厕所 或者 纸 )，这就会造成资源需求的交叉。</p>
<p>​        当然，人希望解决这种问题是十分简单的，但由于线程相当死板，她们会一直抱着自己的所拥有的资源并不断请求另一人所拥有的资源，造成线程的执行被迫停止。这便是死锁。</p>
<p>​        值得一提的是，死锁并不会导致程序结束，而是会一直僵持下去，其余被阻塞的线程也不会被 Cpu 调用运行，Cpu 会一直执着的执行这个已经僵持且无法得到解决的线程。</p>
<p>​        就像鞋带上的死结一般再也解不开，死锁也是如此。</p>
<p>​        造成死锁的四个必要条件：</p>
<ul>
<li>互斥：一个资源每次只能被一个进程使用</li>
<li>请求与保持：一个进程因为请求资源而被阻塞，并且对已经拥有的资源保持不放</li>
<li>不剥夺：进程已经获得的资源，在未使用完前，不能强行剥夺</li>
<li>循环等待：若干进程之间形成头尾相接的循环等待资源关系</li>
</ul>
<p>​        一旦以上的四个条件有一个或者多个不满足，死锁就会被解除。由于死锁的特性，在编写程序时，最好注意不要形成死锁。下面给出一个经典的死锁例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.DeadLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试 死锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDeadLock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MackUp girlOne = <span class="keyword">new</span> MackUp( <span class="number">0</span>, <span class="string">&quot;Anna&quot;</span> );</span><br><span class="line">        MackUp girlTwo = <span class="keyword">new</span> MackUp( <span class="number">1</span>, <span class="string">&quot;Alice&quot;</span> );</span><br><span class="line"></span><br><span class="line">        girlOne.start();</span><br><span class="line">        girlTwo.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 口红</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lipstick</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 镜子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mirror</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 化妆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MackUp</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lipstick lipstick = <span class="keyword">new</span> Lipstick();</span><br><span class="line">    <span class="keyword">static</span> Mirror mirror = <span class="keyword">new</span> Mirror();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> choice;</span><br><span class="line">    String Name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MackUp</span><span class="params">( <span class="keyword">int</span> choice, String Name )</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.choice = choice;</span><br><span class="line">        <span class="keyword">this</span>.Name = Name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mackUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    // 使用此方法时 由于双方都在等待对方的资源，形成死锁</span></span><br><span class="line"><span class="comment">//    public void mackUp()&#123;</span></span><br><span class="line"><span class="comment">//        if ( this.choice == 0 )&#123;</span></span><br><span class="line"><span class="comment">//            synchronized ( lipstick )&#123;</span></span><br><span class="line"><span class="comment">//                System.out.println( this.Name + &quot;-&gt; 获取到 lipstick 的锁&quot; );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    Thread.sleep( 1000 );</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                synchronized ( mirror )&#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println( this.Name + &quot;-&gt; 获取到 mirror 的锁&quot; );</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;else &#123;</span></span><br><span class="line"><span class="comment">//            synchronized ( mirror )&#123;</span></span><br><span class="line"><span class="comment">//                System.out.println( this.Name + &quot;-&gt; 获取到 mirror 的锁&quot; );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    Thread.sleep( 2000 );</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                synchronized ( lipstick )&#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println( this.Name + &quot;-&gt; 获取到 lipstick 的锁&quot; );</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mackUp</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">this</span>.choice == <span class="number">0</span> )&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( lipstick )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; lipstick lock &quot;</span> );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> ( mirror )&#123;</span><br><span class="line">                    System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; mirror lock &quot;</span> );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( mirror )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; mirror lock &quot;</span> );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> ( lipstick )&#123;</span><br><span class="line">                    System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; lipstick lock &quot;</span> );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">2000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        即使上面的 Mirror 类 和 Lipstick 类没有实现具体代码，但是依旧代表了两种所需资源。</p>
<p>​        在这种情况下，一个 synchronized 代码块下包含了另一个 synchronized 代码块，也就是说，执行完这一次线程需要对两个公有资源进行锁定，并且其中的一个公有资源被其他人所拥有。此时就满足了死锁的条件，形成死锁。</p>
<p>​        最重要的一点，死锁并不会释放线程的锁，因此她们会不断的僵持下去，直到电脑爆炸 或者 你人为结束程序。下面我们对上方的代码稍微进行改造，使其解除死锁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.DeadLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试 死锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDeadLock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MackUp girlOne = <span class="keyword">new</span> MackUp( <span class="number">0</span>, <span class="string">&quot;Anna&quot;</span> );</span><br><span class="line">        MackUp girlTwo = <span class="keyword">new</span> MackUp( <span class="number">1</span>, <span class="string">&quot;Alice&quot;</span> );</span><br><span class="line"></span><br><span class="line">        girlOne.start();</span><br><span class="line">        girlTwo.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 口红</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lipstick</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 镜子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mirror</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 化妆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MackUp</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Lipstick lipstick = <span class="keyword">new</span> Lipstick();</span><br><span class="line">    <span class="keyword">static</span> Mirror mirror = <span class="keyword">new</span> Mirror();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> choice;</span><br><span class="line">    String Name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MackUp</span><span class="params">( <span class="keyword">int</span> choice, String Name )</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.choice = choice;</span><br><span class="line">        <span class="keyword">this</span>.Name = Name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mackUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    // 使用此方法时 由于双方都在等待对方的资源，形成死锁</span></span><br><span class="line"><span class="comment">//    public void mackUp()&#123;</span></span><br><span class="line"><span class="comment">//        if ( this.choice == 0 )&#123;</span></span><br><span class="line"><span class="comment">//            synchronized ( lipstick )&#123;</span></span><br><span class="line"><span class="comment">//                System.out.println( this.Name + &quot;-&gt; 获取到 lipstick 的锁&quot; );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    Thread.sleep( 1000 );</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                synchronized ( mirror )&#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println( this.Name + &quot;-&gt; 获取到 mirror 的锁&quot; );</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;else &#123;</span></span><br><span class="line"><span class="comment">//            synchronized ( mirror )&#123;</span></span><br><span class="line"><span class="comment">//                System.out.println( this.Name + &quot;-&gt; 获取到 mirror 的锁&quot; );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                try &#123;</span></span><br><span class="line"><span class="comment">//                    Thread.sleep( 2000 );</span></span><br><span class="line"><span class="comment">//                &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//                    e.printStackTrace();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                synchronized ( lipstick )&#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println( this.Name + &quot;-&gt; 获取到 lipstick 的锁&quot; );</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mackUp</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">this</span>.choice == <span class="number">0</span> )&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( lipstick )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; lipstick lock &quot;</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">1000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> ( mirror )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; mirror lock &quot;</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> ( mirror )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; mirror lock &quot;</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">2000</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> ( lipstick )&#123;</span><br><span class="line">                System.out.println( <span class="keyword">this</span>.Name + <span class="string">&quot; get the -&gt; lipstick lock &quot;</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Lock锁"><a href="#Lock锁" class="headerlink" title="Lock锁"></a>Lock锁</h4><p>​        Lock 是 Java5.0 后的一种可以显示定义的同步方法，Lock 通常以接口的方式被使用，其中 ReentrantLock 实现了 Lock 接口且较为常用。使用 ReentrantLock 可以通过显示定义来定义 Lock 锁，从而通过 Lock 类的实例对象来完成线程同步。</p>
<p>​        虽然 Lock 锁可以显示定义锁，从而达到线程同步的目的，但是日常中还是 synchronized 同步来完成线程同步，下面给出一个使用 Lock 类来完成线程同步的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> TestThread.SeniorLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试 Lock 锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSeniorLock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BuyTickets buyTickets = <span class="keyword">new</span> BuyTickets();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread( buyTickets, <span class="string">&quot;Jojo&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyTickets, <span class="string">&quot;Dio&quot;</span> ).start();</span><br><span class="line">        <span class="keyword">new</span> Thread( buyTickets, <span class="string">&quot;Anna&quot;</span> ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyTickets</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> Tickets = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> ( flag )&#123;</span><br><span class="line">            buy();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep( <span class="number">500</span> );</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( Tickets &lt;= <span class="number">0</span> )&#123;</span><br><span class="line">                <span class="keyword">this</span>.flag = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println( Thread.currentThread().getName() + <span class="string">&quot; gey the &quot;</span> + Tickets + <span class="string">&quot; tickets &quot;</span> );</span><br><span class="line">            Tickets = Tickets - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 解锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        虽然，Lock 类拥有其他的神奇方法，但是一般而言只需要使用 上锁lock(  ) 和 解锁unlock(  ) 这两个方法即可。另外最好将 lock 方法放入 try 句块，而将 unlock 方法放入 finally 句块。</p>
<p>​        被 lock 方法 和 unlock 方法所包含的代码块就会被视为同步代码块。</p>
<h4 id="Lock锁-和-synchronized-的区别"><a href="#Lock锁-和-synchronized-的区别" class="headerlink" title="Lock锁 和 synchronized 的区别"></a>Lock锁 和 synchronized 的区别</h4><ul>
<li>Lock是显示锁（ 手动开启和关闭锁，别忘记关闭锁 ）synchronized 是隐式锁，出了作用域自动释放</li>
<li>Lock 只有代码块锁，synchronized 有代码块锁和方法锁</li>
<li>使用 Lock 锁，JVM 将花费较少的时间来调度线程，性能更好。并且具有更好的扩展性( 提供了更多的子类 )</li>
<li>优先使用顺序：<ul>
<li>Lock &gt; 同步代码块( 已经进入了方法体，分配了相对应的资源 ) &gt; 同步方法( 在方法体外 )</li>
</ul>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/28/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0Two/" rel="prev" title="Java多线程学习笔记--线程状态、静态代理、Lambda表达式">
      <i class="fa fa-chevron-left"></i> Java多线程学习笔记--线程状态、静态代理、Lambda表达式
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/02/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E6%B6%88%E8%B4%B9%E8%80%85%E5%92%8C%E7%94%9F%E4%BA%A7%E8%80%85%E9%97%AE%E9%A2%98/" rel="next" title="Java多线程的学习笔记--消费者和生产者问题">
      Java多线程的学习笔记--消费者和生产者问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%81%E8%AF%9D"><span class="nav-number">1.</span> <span class="nav-text">屁话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-number">2.</span> <span class="nav-text">线程优先级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">守护线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="nav-number">4.</span> <span class="nav-text">线程同步</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E5%A4%A7%E4%B8%8D%E5%AE%89%E5%85%A8%E6%A1%88%E4%BE%8B"><span class="nav-number">4.0.1.</span> <span class="nav-text">三大不安全案例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E5%90%8C%E6%97%B6%E6%8A%A2%E7%A5%A8"><span class="nav-number">4.0.1.0.1.</span> <span class="nav-text">多人同时抢票</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%93%B6%E8%A1%8C%E5%90%8C%E6%97%B6%E5%8F%96%E9%92%B1"><span class="nav-number">4.0.1.0.2.</span> <span class="nav-text">银行同时取钱</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#list-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8"><span class="nav-number">4.0.1.0.3.</span> <span class="nav-text">list 线程不安全</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%9D%97-%E4%BB%A5%E5%8F%8A-%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95"><span class="nav-number">4.0.2.</span> <span class="nav-text">同步块 以及 同步方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%A4%9A%E4%BA%BA%E5%90%8C%E6%97%B6%E6%8A%A2%E7%A5%A8%E2%80%93%E5%90%8C%E6%AD%A5"><span class="nav-number">4.0.2.0.1.</span> <span class="nav-text">多人同时抢票–同步</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%93%B6%E8%A1%8C%E5%90%8C%E6%97%B6%E5%8F%96%E9%92%B1%E2%80%93%E5%90%8C%E6%AD%A5"><span class="nav-number">4.0.2.0.2.</span> <span class="nav-text">银行同时取钱–同步</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#list-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E2%80%93%E5%90%8C%E6%AD%A5"><span class="nav-number">4.0.2.0.3.</span> <span class="nav-text">list 线程不安全–同步</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CopyOnWriteArrayList"><span class="nav-number">4.0.3.</span> <span class="nav-text">CopyOnWriteArrayList</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%81"><span class="nav-number">5.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%81%E7%9A%84%E5%9F%BA%E7%A1%80"><span class="nav-number">5.0.1.</span> <span class="nav-text">锁的基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%BB%E9%94%81"><span class="nav-number">5.0.2.</span> <span class="nav-text">死锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lock%E9%94%81"><span class="nav-number">5.0.3.</span> <span class="nav-text">Lock锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lock%E9%94%81-%E5%92%8C-synchronized-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">5.0.4.</span> <span class="nav-text">Lock锁 和 synchronized 的区别</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-haruto"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>

<!--动态线条背景-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<!--浏览器搞笑标题-->
<script type="text/javascript" src="\js\FunnyTitle.js"></script>
